# XSS adversarial example attacks based on deep reinforcement learning: A Replication and Extension study

This repository contains all the code related to the paper "XSS adversarial example attacks based on deep reinforcement learning: A Replication and Extension study" submitted to COSE.
This work replicates a reference study, underlining someweaknesses of the original work and trying to extend it towards a more effective evaluation strategy, also introducing an oracle to mitigate these threats to validity. 

In the page [Artifacts](docs/artifacts.md) you can find the guide to download the artifacts with their accurate description.

The following paragraphs will provide a guide to reproduce our experiments.

## How to reproduce the experiments

The experiments are executed on a machine with Linux Ubuntu and CUDA installed.
At the moment other machines are not supported, in the future a multi-platform version will become available.

### Creating the environment

The libraries are managed using Poetry.
```
poetry install
poetry shell
```

If you want to include the datasets used in our experiments, do not forget to download them from the [Artifacts](docs/artifacts.md) page and to mount their folder them into the container.

To use the oracle, it is needed to run the FastAPI web server, to do so we created a shell command:
```
./serve_backend.sh
```

### Scripts
In this part the main scripts used to perform the experiments are described. All the other script, related to the data processing and the results analysis, are not described.
Inside the `notebooks` folder, there is the notebook `run_experiment_pipeline.ipynb` that you can use to build the correct pipeline commands used to run all the steps of the experiments. 


### Training the detector
The script `train_detector.py` can be used to train an XSS detector, selecting between CNN, LSTM or MLP architecture. To use it, it is needed to create the dataset and to create the vocabulary. Here there is an example of usage. 

```
python src/train_detector.py --trainset data/10/detectors/train.csv --valset data/10/detectors/val.csv --vocabulary data/10/vocabulary.csv --model cnn --seed 42
```

### Testing the detector
Once the training is completed, the script `test_detector.py` can be used to test the model. Here there is an example of usage. 

```
python src/test_detector.py --testset data/10/detectors/test.csv --vocab_file data/10/vocabulary.csv --model cnn --checkpoint_folder runs/cnn/10/run_0 --seed 42
```

### Training the adversarial agent
The script `train_adversarial_agent.py` can be used to train the adversarial agent, targeting a detection model. The flag `--oracle_guided_reward` can be used to switch between the reward proposed by the reference work or our reward, integrating the oracle into the training procedure. Here there is an example of usage. 

```
python src/train_adversarial_agent.py --trainset data/10/adversarial_agents/train.csv --valset data/10/adversarial_agents/val.csv --config_detector runs/cnn/10/run_0/config.json --runs_folder adversarial_agent --seed 42
```

### Testing the adversarial agent
Once the training is completed, the script `test_adversarial_agent.py` can be used to test the adversarial agent. Here there is an example of usage. 

```
python src/test_adversarial_agent.py --testset data/10/adversarial_agents/test.csv --config_detector runs/cnn/10/run_0/config.json --checkpoint runs/cnn/10/run_0/adversarial_agent/run_0/best_model.zip --seed 42
```

### Testing the adversarial agent against the oracle
The script `test_validity_mutated_dataset.py` can be used to test the attacks generated by the adversarial model against the oracle, to understand if they are still valid XSS attacks. Here there is an example of usage.

```
python src/test_validity_mutated_dataset.py --dataset runs/cnn/10/run_0/adversarial_agent/run_0/empirical_study_set.csv --vocab data/10/vocabulary.csv --seed 42
```

### Computing Ruin Rates
The script `analyze_validity.py` can be used to compute the Ruin Rates and the additional data used for the analysis of the results. Here there is an example of usage.

```
python src/analyze_validity.py --dataset runs/cnn/10/run_0/adversarial_agent/run_0/validity.csv --seed 42
```